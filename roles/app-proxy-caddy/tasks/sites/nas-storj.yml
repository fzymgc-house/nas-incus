---
- name: Configure nas-storj site
  ansible.builtin.blockinfile:
    dest: /etc/caddy/Caddyfile
    mode: "0640"
    owner: caddy
    group: caddy
    marker: "# {mark} NAS-STORJ SITE"
    insertafter: EOF
    append_newline: true
    create: true
    content: "{{ lookup('ansible.builtin.template', 'Caddyfile-site.j2', variable_start_string='%[', variable_end_string=']%', block_start_string='%[-', block_end_string='%]',
      template_vars=dict(
        site_fqdn='nas-storj.fzymgc.house',
        site_upstream_url='http://192.168.20.200:20909',
        site_tls_cloudflare=true,
        site_upstream_tls=false,
        use_local_resolvers=true
      )) }}"
    validate: "/usr/bin/caddy validate --adapter caddyfile --config %s"
  notify:
    - Restart caddy
  tags:
    - caddy
    - caddy-sites